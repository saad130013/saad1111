import pandas as pd
import streamlit as st

class TransactionClassifier:
    """
    مسؤول عن تصنيف حركات كشف الحساب البنكي إلى حسابات محاسبية.
    """
    def __init__(self, df):
        self.df = df
        # يمكن توسيع هذه الخريطة لتشمل المزيد من التفاصيل والقواعد
        self.account_mapping = {
            # المصروفات (الحركات المدينة)
            'تحويل داخلي صادر': 'مصاريف تشغيل',
            'حوالة فورية محلية صادرة': 'مصاريف مشتريات',
            'ضريبة القيمة المضافة': 'مصاريف ضرائب',
            'رسوم تحويل': 'مصاريف بنكية',
            'مدفوعات سداد': 'مصاريف سداد قروض',
            'شراء محلي عبر الإنترنت': 'مصاريف مشتريات',
            'سحب نقدي': 'سحوبات نقدية',
            'راتب': 'مصاريف رواتب',
            'إيجار': 'مصاريف إيجار',
            'فواتير': 'مصاريف خدمات',
            'مشتريات': 'مصاريف مشتريات',
            'رسوم': 'مصاريف بنكية',
            'عمولة': 'مصاريف بنكية',
            'سداد': 'مصاريف سداد',
            'تحويل': 'مصاريف تحويلات',
            'خصم': 'مصاريف متنوعة',
            
            # الإيرادات (الحركات الدائنة)
            'حوالة محلية واردة': 'إيرادات عمليات',
            'حوالة فورية محلية واردة': 'إيرادات عمليات',
            'استرداد عملية سداد': 'إيرادات متنوعة',
            'تحويل داخلي وارد': 'إيرادات تحويلات',
            'بيع': 'إيرادات مبيعات',
            'ايداع': 'إيرادات إيداعات',
            'إيراد': 'إيرادات متنوعة',
            'رد': 'إيرادات متنوعة'
        }

    def classify_transactions(self):
        """
        تصنيف الحركات باستخدام خريطة الحسابات المحاسبية.
        """
        if self.df is None or 'التفاصيل' not in self.df.columns:
            return self.df

        st.info("جاري تصنيف الحركات المحاسبية...")
        
        # إنشاء عمود جديد للحساب المحاسبي
        self.df['الحساب المحاسبي'] = 'حسابات متنوعة'
        
        # تطبيق التصنيف بناءً على التطابق التام
        self.df['الحساب المحاسبي'] = self.df['التفاصيل'].map(self.account_mapping).fillna(self.df['الحساب المحاسبي'])
        
        # تطبيق التصنيف بناءً على الكلمات المفتاحية (لجعلها أكثر احترافية ومرونة)
        for keyword, account in self.account_mapping.items():
            # استخدام str.contains للبحث عن الكلمة المفتاحية في عمود 'التفاصيل'
            # نستخدم .str.lower() لضمان البحث غير الحساس لحالة الأحرف
            mask = self.df['التفاصيل'].str.lower().str.contains(keyword.lower(), na=False)
            # نطبق التصنيف فقط على الحركات التي لم يتم تصنيفها بعد (أي لا تزال 'حسابات متنوعة')
            # هذا يضمن أن التطابق التام له الأولوية
            self.df.loc[mask & (self.df['الحساب المحاسبي'] == 'حسابات متنوعة'), 'الحساب المحاسبي'] = account
            
        # إعادة تصنيف الحركات التي تم تصنيفها بالتطابق التام
        self.df['الحساب المحاسبي'] = self.df['التفاصيل'].map(self.account_mapping).fillna(self.df['الحساب المحاسبي'])
        
        # تطبيق التصنيف بناءً على الكلمات المفتاحية مرة أخرى، ولكن هذه المرة للجميع
        for keyword, account in self.account_mapping.items():
            mask = self.df['التفاصيل'].str.lower().str.contains(keyword.lower(), na=False)
            self.df.loc[mask, 'الحساب المحاسبي'] = account
            
        st.success("✅ تم تصنيف الحركات المحاسبية بنجاح")
        return self.df
