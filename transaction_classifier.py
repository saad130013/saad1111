import pandas as pd

class TransactionClassifier:
    """
    مسؤول عن تصنيف الحركات البنكية إلى حسابات محاسبية.
    """
    def __init__(self, df):
        self.df = df
        self.classification_rules = self._load_rules()

    def _load_rules(self):
        """
        تحميل قواعد التصنيف.
        """
        return {
            'مصاريف مشتريات': ['شراء', 'مشتريات', 'سوق', 'متجر', 'سوبر ماركت', 'مؤسسة'],
            'مصاريف ضرائب': ['ضريبة', 'ضرايب', 'vat'],
            'مصاريف بنكية': ['رسوم', 'عمولة', 'بنك', 'bank', 'fee'],
            'مصاريف تشغيل': ['ايجار', 'راتب', 'كهرباء', 'ماء', 'صيانة', 'تشغيل'],
            'إيرادات مبيعات': ['مبيعات', 'بيع', 'تحصيل'],
            'إيرادات متنوعة': ['ايداع', 'تحويل', 'حوالة', 'واردة', 'دخل'],
            'سحوبات نقدية': ['سحب نقدي', 'صراف آلي', 'atm'],
            'تحويلات داخلية': ['تحويل داخلي', 'نقل رصيد']
        }

    def classify_transactions(self):
        """
        تطبيق قواعد التصنيف على عمود التفاصيل.
        """
        self.df['الحساب المحاسبي'] = 'حسابات متنوعة'
        
        # التأكد من أن عمود التفاصيل موجود
        if 'التفاصيل' not in self.df.columns:
            return self.df

        # تحويل عمود التفاصيل إلى نص لضمان عمل البحث
        self.df['التفاصيل_نص'] = self.df['التفاصيل'].astype(str).str.lower()

        for account, keywords in self.classification_rules.items():
            for keyword in keywords:
                # تطبيق التصنيف على الحركات التي لم يتم تصنيفها بعد
                mask = (self.df['الحساب المحاسبي'] == 'حسابات متنوعة') & (self.df['التفاصيل_نص'].str.contains(keyword))
                self.df.loc[mask, 'الحساب المحاسبي'] = account
        
        # تصنيف الحركات المتبقية بناءً على طبيعتها (مدين/دائن)
        # الحركات المدينة المتبقية (مصروفات أخرى)
        self.df.loc[(self.df['الحساب المحاسبي'] == 'حسابات متنوعة') & (self.df['مدين'] > 0), 'الحساب المحاسبي'] = 'مصاريف أخرى'
        
        # الحركات الدائنة المتبقية (إيرادات أخرى)
        self.df.loc[(self.df['الحساب المحاسبي'] == 'حسابات متنوعة') & (self.df['دائن'] > 0), 'الحساب المحاسبي'] = 'إيرادات أخرى'
        
        # إزالة عمود التفاصيل المؤقت
        self.df = self.df.drop(columns=['التفاصيل_نص'])
        
        return self.df
